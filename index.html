<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Florida Animal Cruelty Case Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 450px;
            border-radius: 0.5rem;
            z-index: 10;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .stat-card {
            transition: background-color 0.3s, transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .loader {
            border-top-color: #ef4444;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
        }
        .leaflet-popup-content {
            margin: 1rem;
        }
        .leaflet-popup-tip {
             background: white;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-red-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <h1 class="text-2xl font-bold text-gray-800">Florida Animal Cruelty Case Tracker</h1>
                </div>
                 <div class="flex items-center gap-2">
                    <button id="submit-case-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Submit a Case
                    </button>
                    <button id="report-case-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                        Report Abuse
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <div class="mb-8 p-6 bg-white rounded-lg shadow-sm">
             <h2 class="text-xl font-semibold text-gray-800 mb-2">A Real-Time, Collaborative Case Monitor</h2>
             <p class="text-gray-600">This dashboard provides a centralized, real-time view of animal cruelty cases across Florida, powered by user submissions and a live database. Use the "Submit a Case" button to add new cases and contribute to this public awareness effort. All submissions are visible to all users instantly.</p>
        </div>

        <!-- Map Section -->
        <div class="mb-8 bg-white p-6 rounded-lg shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Case Map</h3>
            <div id="map"></div>
        </div>


        <div id="stats-overview" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
             <!-- Stat cards populated by JS -->
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mb-8">
            <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-sm"><canvas id="county-chart"></canvas></div>
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm"><canvas id="status-chart"></canvas></div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="lg:col-span-2">
                    <label for="search" class="block text-sm font-medium text-gray-700">Search</label>
                    <input type="text" id="search" placeholder="Defendant or Case #" autocomplete="off" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm h-10 px-3">
                </div>
                <div>
                    <label for="county-filter" class="block text-sm font-medium text-gray-700">County</label>
                    <select id="county-filter" autocomplete="off" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm h-10 px-2"><option value="">All</option></select>
                </div>
                <div>
                    <label for="status-filter" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="status-filter" autocomplete="off" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm h-10 px-2"><option value="">All</option></select>
                </div>
                <div>
                    <label for="date-filter" class="block text-sm font-medium text-gray-700">Incident After</label>
                    <input type="text" id="date-filter" placeholder="Any Date" autocomplete="off" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm h-10 px-3">
                </div>
            </div>
        </div>
        
        <div id="loading-spinner" class="text-center py-12">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32 mx-auto"></div>
            <h3 class="text-2xl font-semibold text-gray-500 mt-4">Loading Cases...</h3>
        </div>
        <div id="case-listings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
        <div id="no-results" class="hidden text-center py-12">
             <h3 class="text-2xl font-semibold text-gray-500">No Cases Found</h3>
             <p class="text-gray-400 mt-2">The database is currently empty. Be the first to submit a case!</p>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DATA and CONFIG ---
        const countyCoordinates = {
            'Alachua': [29.6516, -82.3248], 'Baker': [30.3269, -82.2858], 'Bay': [30.1766, -85.6602], 'Bradford': [29.9538, -82.1192], 'Brevard': [28.5383, -80.6622], 'Broward': [26.1224, -80.1373], 'Calhoun': [30.4468, -85.1221], 'Charlotte': [26.9079, -82.0834], 'Citrus': [28.8486, -82.4984], 'Clay': [29.9863, -81.7789], 'Collier': [26.1420, -81.7948], 'Columbia': [30.1897, -82.6393], 'DeSoto': [27.2178, -81.8545], 'Dixie': [29.5319, -83.1118], 'Duval': [30.3322, -81.6557], 'Escambia': [30.4213, -87.2169], 'Flagler': [29.4758, -81.2095], 'Franklin': [29.7435, -84.9768], 'Gadsden': [30.5846, -84.5710], 'Gilchrist': [29.6897, -82.8235], 'Glades': [26.9634, -81.3320], 'Gulf': [29.6635, -85.2938], 'Hamilton': [30.5188, -82.9437], 'Hardee': [27.5453, -81.8023], 'Hendry': [26.7559, -81.2581], 'Hernando': [28.5350, -82.3815], 'Highlands': [27.4914, -81.4601], 'Hillsborough': [27.9506, -82.4572], 'Holmes': [30.7713, -85.8455], 'Indian River': [27.6389, -80.3973], 'Jackson': [30.7752, -85.2341], 'Jefferson': [30.5391, -83.8710], 'Lafayette': [30.0619, -83.2504], 'Lake': [28.8033, -81.8762], 'Lee': [26.6406, -81.8721], 'Leon': [30.4383, -84.2807], 'Levy': [29.1866, -82.8718], 'Liberty': [30.2224, -84.9566], 'Madison': [30.4688, -83.4110], 'Manatee': [27.4989, -82.5748], 'Marion': [29.1872, -82.1401], 'Martin': [27.1995, -80.2520], 'Miami-Dade': [25.7617, -80.1918], 'Monroe': [24.5551, -81.7800], 'Nassau': [30.6272, -81.6904], 'Okaloosa': [30.4049, -86.5919], 'Okeechobee': [27.2431, -80.8281], 'Orange': [28.5383, -81.3792], 'Osceola': [28.2917, -81.2914], 'Palm Beach': [26.7056, -80.0364], 'Pasco': [28.2256, -82.4065], 'Pinellas': [27.7630, -82.6401], 'Polk': [28.0461, -81.7145], 'Putnam': [29.6480, -81.6373], 'St. Johns': [29.8947, -81.3145], 'St. Lucie': [27.4467, -80.3256], 'Santa Rosa': [30.4180, -87.2178], 'Sarasota': [27.3364, -82.5307], 'Seminole': [28.5714, -81.3328], 'Sumter': [28.6983, -82.0493], 'Suwannee': [30.2916, -82.9365], 'Taylor': [30.0519, -83.5826], 'Union': [30.0158, -82.3418], 'Volusia': [29.0280, -81.3087], 'Wakulla': [30.1705, -84.3802], 'Walton': [30.4216, -86.1013], 'Washington': [30.7818, -85.5505]
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db, casesCollection;
        let allCases = [];
        
        // --- DOM & MAP ELEMENTS ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const caseListings = document.getElementById('case-listings');
        const noResultsDiv = document.getElementById('no-results');
        const searchInput = document.getElementById('search');
        const countyFilter = document.getElementById('county-filter');
        const statusFilter = document.getElementById('status-filter');
        const dateFilter = document.getElementById('date-filter');
        const modalContainer = document.getElementById('modal-container');
        const reportCaseBtn = document.getElementById('report-case-btn');
        const submitCaseBtn = document.getElementById('submit-case-btn');

        let countyChart, statusChart;
        let map;
        let markerLayer = L.layerGroup();

        // --- FUNCTIONS ---
        
            
                async function initializeAppAndData() {
            // This placeholder is replaced by the GitHub Action during deployment
            const firebaseConfig = '__FIREBASE_CONFIG_PLACEHOLDER__';

            if (typeof firebaseConfig !== 'object' || !firebaseConfig.apiKey) {
                loadingSpinner.innerHTML = `
                    <div class="text-red-600 bg-red-100 border border-red-400 rounded-lg p-4 max-w-2xl mx-auto">
                        <h3 class="font-bold text-lg">Configuration Error</h3>
                        <p class="mt-2">Firebase configuration is missing or invalid. For a live deployment, please ensure the 'FIREBASE_CONFIG' secret is correctly set in your repository's Actions secrets and that the deployment workflow has run successfully.</p>
                    </div>`;
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, user => {
                    if (user) {
                        const casesCollectionPath = `/artifacts/${appId}/public/data/cases`;
                        casesCollection = collection(db, casesCollectionPath);
                        setupRealtimeListener();
                    } else {
                         loadingSpinner.innerHTML = '<p class="text-red-500 font-semibold">Authentication failed. Unable to load cases.</p>';
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingSpinner.innerHTML = '<p class="text-red-500 font-semibold">Error connecting to the database. Please check your Firebase configuration.</p>';
            }
        }



        function setupRealtimeListener() {
            onSnapshot(casesCollection, (snapshot) => {
                allCases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadingSpinner.classList.add('hidden');
                caseListings.classList.remove('hidden');
                
                populateFilters();
                applyFilters();
            }, (error) => {
                console.error("Error listening to database:", error);
                loadingSpinner.innerHTML = '<p class="text-red-500 font-semibold">Error fetching real-time data.</p>';
            });
        }
        
        function renderCases(casesToRender) {
            caseListings.innerHTML = '';
            
            noResultsDiv.classList.toggle('hidden', casesToRender.length > 0);
            caseListings.classList.toggle('hidden', casesToRender.length === 0);

            casesToRender.forEach(caseData => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm overflow-hidden transform hover:-translate-y-1 transition-transform duration-300';
                
                const statusColors = {
                    'Pending Trial': 'bg-yellow-500', 'Awaiting Plea': 'bg-blue-500',
                    'Sentenced': 'bg-green-600', 'Arrested': 'bg-indigo-500',
                    'Pending Review': 'bg-pink-500'
                };
                const statusColor = statusColors[caseData.status] || 'bg-gray-500';

                card.innerHTML = `
                    <div class="p-5">
                        <div class="flex justify-between items-start">
                             <p class="text-sm text-gray-500">${caseData.county} County</p>
                             <span class="text-xs font-semibold text-white ${statusColor} px-2 py-1 rounded-full">${caseData.status}</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mt-2">${caseData.defendant}</h3>
                        <p class="text-sm text-gray-600">${caseData.caseNumber ? `Case #${caseData.caseNumber}`: '&nbsp;'}</p>
                        <div class="mt-4 border-t border-gray-200 pt-4">
                            <p class="text-sm"><strong class="font-medium text-gray-700">Incident:</strong> ${caseData.incidentDate}</p>
                            <p class="text-sm"><strong class="font-medium text-gray-700">Animal:</strong> ${caseData.animalType}</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-5 py-3 flex justify-between items-center">
                        <button class="view-details-btn text-sm font-semibold text-red-600 hover:text-red-800" data-case-id="${caseData.id}">View Details</button>
                        ${caseData.isUserSubmitted ? '<span class="text-xs text-gray-400">User Submitted</span>' : ''}
                    </div>
                `;
                caseListings.appendChild(card);
            });
            
            document.querySelectorAll('.view-details-btn').forEach(button => {
                button.addEventListener('click', (e) => openModal(e.target.dataset.caseId, 'details'));
            });
        }
        
        function populateFilters() {
            const counties = [...new Set(allCases.map(c => c.county))];
            const statuses = [...new Set(allCases.map(c => c.status))];
            
            const repopulateSelect = (selectEl, options) => {
                const currentValue = selectEl.value;
                selectEl.innerHTML = '<option value="">All</option>';
                options.sort().forEach(opt => {
                     const option = document.createElement('option');
                     option.value = opt;
                     option.textContent = opt;
                     selectEl.appendChild(option);
                });
                selectEl.value = currentValue;
            };

            repopulateSelect(countyFilter, counties);
            repopulateSelect(statusFilter, statuses);
        }
        
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCounty = countyFilter.value;
            const selectedStatus = statusFilter.value;
            const selectedDate = dateFilter.value;

            const filteredCases = allCases.filter(c => {
                const s = c.defendant?.toLowerCase() || '';
                const cn = c.caseNumber?.toLowerCase() || '';
                const matchesSearch = s.includes(searchTerm) || cn.includes(searchTerm);
                const matchesCounty = !selectedCounty || c.county === selectedCounty;
                const matchesStatus = !selectedStatus || c.status === selectedStatus;
                const matchesDate = !selectedDate || c.incidentDate >= selectedDate;
                return matchesSearch && matchesCounty && matchesStatus && matchesDate;
            });

            renderCases(filteredCases);
            updateCharts(filteredCases);
            updateStats(filteredCases);
            updateMap(filteredCases);
        }

        function openModal(identifier, type) {
            let modalHTML = '';
            
            const baseModal = (title, content, footer) => `
                <div id="modal-backdrop" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl transform scale-100 overflow-y-auto max-h-full">
                        <div class="p-6 sm:p-8">
                            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white pt-2 pb-2">
                                <h2 class="text-2xl font-bold text-gray-900">${title}</h2>
                                <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                            </div>
                            ${content}
                        </div>
                        <div class="bg-gray-100 px-6 py-4 text-right rounded-b-xl sticky bottom-0">${footer}</div>
                    </div>
                </div>
            `;
            
            if (type === 'report') {
                modalHTML = baseModal('How to Report Animal Cruelty', 
                    `<div class="text-gray-700 space-y-4">
                        <p class="font-bold text-red-600">If you witness an animal in a life-threatening situation, call 911 immediately.</p>
                        <p>For non-emergency concerns, contact your local county sheriff's office or animal control agency. They enforce Florida's animal cruelty laws (Chapter 828).</p>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Helpful Resources:</h4>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>FWC Wildlife Alert:</strong> For wildlife concerns, call <a href="tel:888-404-3922" class="text-blue-600 hover:underline">888-404-FWCC (3922)</a>.</li>
                                <li><strong>National Link Coalition:</strong> Guidance on <a href="https://nationallinkcoalition.org/how-do-i-report-suspected-abuse" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">Reporting Suspected Abuse</a>.</li>
                            </ul>
                        </div>
                    </div>`,
                    `<button class="close-modal-btn px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Close</button>`
                );
            } else if (type === 'submit') {
                 modalHTML = baseModal('Submit a New Case', 
                    `<form id="submit-case-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="defendant" class="block text-sm font-medium">Defendant Name*</label><input type="text" id="defendant" required class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div>
                            <div><label for="county" class="block text-sm font-medium">County*</label><input type="text" id="county" required class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div>
                            <div><label for="caseNumber" class="block text-sm font-medium">Case Number (Optional)</label><input type="text" id="caseNumber" class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div>
                            <div><label for="incidentDate" class="block text-sm font-medium">Incident Date*</label><input type="date" id="incidentDate" required class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div>
                        </div>
                        <div><label for="animalType" class="block text-sm font-medium">Animal Type(s)*</label><input type="text" id="animalType" placeholder="e.g., Dogs, Cats" required class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div>
                        <div><label for="summary" class="block text-sm font-medium">Summary of Allegations*</label><textarea id="summary" rows="3" required class="mt-1 w-full border-gray-300 rounded-md p-3"></textarea></div>
                        <div><label for="source" class="block text-sm font-medium">Source Link (News, Public Record, etc.)*</label><input type="url" id="source" required placeholder="https://" class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div>
                        <div id="submit-error" class="text-red-600 text-sm hidden font-semibold"></div>
                        <p class="text-xs text-gray-500">*Required field. Submitted cases will be marked as 'Pending Review'.</p>
                    </form>`,
                    `<button id="form-submit-btn" type="submit" form="submit-case-form" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Submit Case</button>`
                );

            } else if (type === 'details') {
                const caseData = allCases.find(c => c.id === identifier);
                if (!caseData) return;
                 modalHTML = baseModal('Case Details', 
                    `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-gray-700">
                        <div><strong class="font-semibold text-gray-900">Case #:</strong> ${caseData.caseNumber || 'N/A'}</div>
                        <div><strong class="font-semibold text-gray-900">County:</strong> ${caseData.county}</div>
                        <div class="md:col-span-2"><strong class="font-semibold text-gray-900">Defendant:</strong> ${caseData.defendant}</div>
                        <div><strong class="font-semibold text-gray-900">Incident Date:</strong> ${caseData.incidentDate}</div>
                        <div><strong class="font-semibold text-gray-900">Arrest Date:</strong> ${caseData.arrestDate || 'N/A'}</div>
                        <div><strong class="font-semibold text-gray-900">Status:</strong> ${caseData.status}</div>
                        <div><strong class="font-semibold text-gray-900">Next Court Date:</strong> ${caseData.nextCourtDate || 'N/A'}</div>
                        <div class="md:col-span-2"><strong class="font-semibold text-gray-900">Agency:</strong> ${caseData.agency || 'N/A'}</div>
                    </div>
                    <div class="mt-6 border-t pt-4"><h4 class="font-semibold text-gray-900 mb-2">Charges</h4><ul class="list-disc list-inside space-y-1 text-gray-700">${Array.isArray(caseData.charges) && caseData.charges.length > 0 ? caseData.charges.map(charge => `<li>${charge}</li>`).join('') : '<li>Information not available</li>'}</ul></div>
                     <div class="mt-4 border-t pt-4"><h4 class="font-semibold text-gray-900 mb-2">Summary</h4><p class="text-gray-700 leading-relaxed">${caseData.summary}</p></div>
                     ${caseData.source ? `<div class="mt-4 border-t pt-4"><h4 class="font-semibold text-gray-900 mb-2">Source</h4><a href="${caseData.source}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline break-all">${caseData.source}</a></div>` : ''}
                    `,
                    `<button class="close-modal-btn px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Close</button>`
                );
            }
            
            modalContainer.innerHTML = modalHTML;
            modalContainer.querySelector('.close-modal-btn').addEventListener('click', closeModal);
            modalContainer.querySelector('#modal-backdrop')?.addEventListener('click', (e) => { if(e.target.id === 'modal-backdrop') closeModal() });

            if (type === 'submit') {
                document.getElementById('submit-case-form').addEventListener('submit', handleCaseSubmit);
            }
        }

        function closeModal() {
            const modal = modalContainer.querySelector('#modal-backdrop');
            if (modal) {
                modal.classList.add('opacity-0');
                 setTimeout(() => { modalContainer.innerHTML = ''; }, 300);
            }
        }

        async function handleCaseSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = document.getElementById('form-submit-btn');
            const errorDiv = document.getElementById('submit-error');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 inline-block mr-2 -mb-2"></span>Submitting...';
            errorDiv.classList.add('hidden');

            const newCase = {
                defendant: form.defendant.value, county: form.county.value,
                caseNumber: form.caseNumber.value || null, incidentDate: form.incidentDate.value,
                animalType: form.animalType.value, summary: form.summary.value,
                source: form.source.value, status: 'Pending Review', isUserSubmitted: true,
                createdAt: new Date().toISOString(), arrestDate: null, nextCourtDate: null, agency: null, charges: []
            };

            try {
                await addDoc(casesCollection, newCase);
                closeModal();
            } catch (error) {
                console.error("Error submitting case:", error);
                errorDiv.textContent = 'Submission failed. Please try again.';
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Case';
            }
        }


        function updateStats(statsCases) {
            const statsContainer = document.getElementById('stats-overview');
            const totalCases = statsCases.length;
            const totalCounties = [...new Set(statsCases.map(c => c.county))].length;

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const newCasesCount = statsCases.filter(c => new Date(c.arrestDate || c.createdAt) > thirtyDaysAgo).length;

            statsContainer.innerHTML = `
                <div class="stat-card bg-white p-5 rounded-lg shadow-sm flex items-center"><div class="bg-blue-100 p-3 rounded-full mr-4"><svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></div><div><p class="text-sm text-gray-500">Total Cases</p><p class="text-2xl font-bold text-gray-800">${totalCases}</p></div></div>
                <div class="stat-card bg-white p-5 rounded-lg shadow-sm flex items-center"><div class="bg-green-100 p-3 rounded-full mr-4"><svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div><div><p class="text-sm text-gray-500">Counties</p><p class="text-2xl font-bold text-gray-800">${totalCounties}</p></div></div>
                <div class="stat-card bg-white p-5 rounded-lg shadow-sm flex items-center"><div class="bg-yellow-100 p-3 rounded-full mr-4"><svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div><div><p class="text-sm text-gray-500">New (30d)</p><p class="text-2xl font-bold text-gray-800">${newCasesCount}</p></div></div>
            `;
        }

        function createCharts() {
            Chart.defaults.font.family = "'Inter', sans-serif";
            const countyCtx = document.getElementById('county-chart').getContext('2d');
            countyChart = new Chart(countyCtx, { type: 'bar', data: { labels: [], datasets: [{ label: '# of Cases', data: [], backgroundColor: 'rgba(220, 38, 38, 0.6)', borderColor: 'rgba(220, 38, 38, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, responsive: true, maintainAspectRatio: false } });

            const statusCtx = document.getElementById('status-chart').getContext('2d');
            statusChart = new Chart(statusCtx, { type: 'doughnut', data: { labels: [], datasets: [{ label: 'Cases', data: [], backgroundColor: ['#FBBF24', '#3B82F6', '#16A34A', '#6366F1', '#EC4899', '#6B7280'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } });
        }
        
        function updateCharts(chartCases) {
            const countyCounts = chartCases.reduce((acc, c) => { acc[c.county] = (acc[c.county] || 0) + 1; return acc; }, {});
            const sortedCounties = Object.keys(countyCounts).sort((a, b) => countyCounts[b] - countyCounts[a]);
            countyChart.data.labels = sortedCounties;
            countyChart.data.datasets[0].data = sortedCounties.map(county => countyCounts[county]);
            countyChart.update();

            const statusCounts = chartCases.reduce((acc, c) => { acc[c.status] = (acc[c.status] || 0) + 1; return acc; }, {});
            statusChart.data.labels = Object.keys(statusCounts);
            statusChart.data.datasets[0].data = Object.values(statusCounts);
            statusChart.update();
        }

        function initializeMap() {
            map = L.map('map').setView([28.5, -82.5], 7);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
            markerLayer.addTo(map);
        }

        function updateMap(casesToDisplay) {
            markerLayer.clearLayers();
            const markers = [];
            
            casesToDisplay.forEach(c => {
                const coords = countyCoordinates[c.county];
                if (coords) {
                    const marker = L.marker(coords);
                    const popupContent = `
                        <div class="text-base">
                            <h4 class="font-bold">${c.defendant}</h4>
                            <p class="text-gray-600">${c.county} County</p>
                            <p><span class="font-semibold">Status:</span> ${c.status}</p>
                            <button class="popup-view-details mt-2 text-sm font-semibold text-red-600 hover:text-red-800" data-case-id="${c.id}">View Details</button>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    markers.push(marker);
                }
            });
            
            markers.forEach(m => markerLayer.addLayer(m));
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndData();
            initializeMap();
            createCharts();

            const setupListeners = () => {
                 searchInput.addEventListener('input', applyFilters);
                 countyFilter.addEventListener('change', applyFilters);
                 statusFilter.addEventListener('change', applyFilters);
                 
                 const dateFilterInput = document.getElementById('date-filter');
                 dateFilterInput.addEventListener('focus', () => { dateFilterInput.type = 'date'; });
                 dateFilterInput.addEventListener('blur', () => { if (!dateFilterInput.value) { dateFilterInput.type = 'text'; } });
                 dateFilterInput.addEventListener('change', applyFilters);

                 reportCaseBtn.addEventListener('click', () => openModal(null, 'report'));
                 submitCaseBtn.addEventListener('click', () => openModal(null, 'submit'));
                 window.addEventListener('keydown', (e) => {
                     if (e.key === 'Escape' && modalContainer.innerHTML !== '') closeModal();
                 });

                // Attach listener to the container for delegated events
                modalContainer.addEventListener('click', e => {
                    if (e.target.matches('.popup-view-details')) {
                        map.closePopup();
                        openModal(e.target.dataset.caseId, 'details');
                    }
                });
            };
            setupListeners();
        });

    </script>
</body>
</html>

