<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Florida Animal Cruelty Case Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 450px;
            border-radius: 0.5rem;
            z-index: 10;
        }
        .toast {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s, transform 0.3s;
            transform: translateY(20px);
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .loader {
            border-top-color: #ef4444;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        input[type="date"]:not(:valid):before {
            content: "Any Date";
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-red-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <h1 class="text-2xl font-bold text-gray-800">Florida Animal Cruelty Case Tracker</h1>
                </div>
                 <div class="flex items-center gap-2">
                    <button id="submit-case-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Submit a Case
                    </button>
                    <button id="report-case-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                        Report Abuse
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <div class="mb-8 p-6 bg-white rounded-lg shadow-sm">
             <h2 class="text-xl font-semibold text-gray-800 mb-2">A Real-Time, Collaborative Case Monitor</h2>
             <p class="text-gray-600">This dashboard provides a centralized, real-time view of animal cruelty cases across Florida, powered by user submissions and a live database. Use the "Submit a Case" button to add new cases and contribute to this public awareness effort. All submissions are visible to all users instantly.</p>
        </div>

        <!-- Statistics Overview Section -->
        <div id="stats-overview" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
             <div class="bg-white p-5 rounded-lg shadow-sm flex items-center"><div class="p-3 rounded-full bg-red-100 mr-4"><svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div><div><p class="text-sm text-gray-500">Total Cases</p><p id="total-cases-stat" class="text-2xl font-bold">0</p></div></div>
             <div class="bg-white p-5 rounded-lg shadow-sm flex items-center"><div class="p-3 rounded-full bg-blue-100 mr-4"><svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div><div><p class="text-sm text-gray-500">Pending Cases</p><p id="pending-cases-stat" class="text-2xl font-bold">0</p></div></div>
             <div class="bg-white p-5 rounded-lg shadow-sm flex items-center"><div class="p-3 rounded-full bg-green-100 mr-4"><svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div><div><p class="text-sm text-gray-500">Counties Represented</p><p id="county-count-stat" class="text-2xl font-bold">0</p></div></div>
        </div>

        <!-- Map Section -->
        <div class="mb-8 bg-white p-6 rounded-lg shadow-sm">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Case Map</h3>
            <div id="map"></div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mb-8">
            <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-sm"><canvas id="county-chart"></canvas></div>
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm"><canvas id="status-chart"></canvas></div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div><label for="search" class="block text-sm font-medium text-gray-700">Search</label><input type="text" id="search" placeholder="Defendant or Case #" autocomplete="off" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm h-10 px-3"></div>
                <div><label for="county-filter" class="block text-sm font-medium text-gray-700">County</label><select id="county-filter" autocomplete="off" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm h-10 px-2"><option value="">All</option></select></div>
                <div><label for="status-filter" class="block text-sm font-medium text-gray-700">Status</label><select id="status-filter" autocomplete="off" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm h-10 px-2"><option value="">All</option></select></div>
                <div><label for="date-filter" class="block text-sm font-medium text-gray-700">Incident After</label><input type="date" id="date-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm h-10 px-3 text-gray-500"></div>
            </div>
        </div>
        
        <div id="loading-spinner" class="text-center py-12"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32 mx-auto"></div><h3 class="text-2xl font-semibold text-gray-500 mt-4">Loading Cases...</h3></div>
        <div id="case-listings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
        <div id="no-results" class="hidden text-center py-12"><h3 class="text-2xl font-semibold text-gray-500">No Cases Found</h3><p id="no-results-message" class="text-gray-400 mt-2">The database is currently empty or no cases match your filters.</p></div>
    </main>
    
    <!-- Modals -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-5 right-5 bg-green-600 text-white py-3 px-5 rounded-lg shadow-xl">
        <p id="toast-message"></p>
    </div>

    <!-- Datalist for county autocomplete -->
    <datalist id="county-list"></datalist>

    <script type="module">
        import { firebaseConfig } from './firebaseConfig.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL DECLARATIONS ---
        const countyCoordinates = { 'Alachua': [29.6516, -82.3248], 'Baker': [30.3269, -82.2858], 'Bay': [30.1766, -85.6602], 'Bradford': [29.9538, -82.1192], 'Brevard': [28.5383, -80.6622], 'Broward': [26.1224, -80.1373], 'Calhoun': [30.4468, -85.1221], 'Charlotte': [26.9079, -82.0834], 'Citrus': [28.8486, -82.4984], 'Clay': [29.9863, -81.7789], 'Collier': [26.1420, -81.7948], 'Columbia': [30.1897, -82.6393], 'DeSoto': [27.2178, -81.8545], 'Dixie': [29.5319, -83.1118], 'Duval': [30.3322, -81.6557], 'Escambia': [30.4213, -87.2169], 'Flagler': [29.4758, -81.2095], 'Franklin': [29.7435, -84.9768], 'Gadsden': [30.5846, -84.5710], 'Gilchrist': [29.6897, -82.8235], 'Glades': [26.9634, -81.3320], 'Gulf': [29.6635, -85.2938], 'Hamilton': [30.5188, -82.9437], 'Hardee': [27.5453, -81.8023], 'Hendry': [26.7559, -81.2581], 'Hernando': [28.5350, -82.3815], 'Highlands': [27.4914, -81.4601], 'Hillsborough': [27.9506, -82.4572], 'Holmes': [30.7713, -85.8455], 'Indian River': [27.6389, -80.3973], 'Jackson': [30.7752, -85.2341], 'Jefferson': [30.5391, -83.8710], 'Lafayette': [30.0619, -83.2504], 'Lake': [28.8033, -81.8762], 'Lee': [26.6406, -81.8721], 'Leon': [30.4383, -84.2807], 'Levy': [29.1866, -82.8718], 'Liberty': [30.2224, -84.9566], 'Madison': [30.4688, -83.4110], 'Manatee': [27.4989, -82.5748], 'Marion': [29.1872, -82.1401], 'Martin': [27.1995, -80.2520], 'Miami-Dade': [25.7617, -80.1918], 'Monroe': [24.5551, -81.7800], 'Nassau': [30.6272, -81.6904], 'Okaloosa': [30.4049, -86.5919], 'Okeechobee': [27.2431, -80.8281], 'Orange': [28.5383, -81.3792], 'Osceola': [28.2917, -81.2914], 'Palm Beach': [26.7056, -80.0364], 'Pasco': [28.2256, -82.4065], 'Pinellas': [27.7630, -82.6401], 'Polk': [28.0461, -81.7145], 'Putnam': [29.6480, -81.6373], 'St. Johns': [29.8947, -81.3145], 'St. Lucie': [27.4467, -80.3256], 'Santa Rosa': [30.4180, -87.2178], 'Sarasota': [27.3364, -82.5307], 'Seminole': [28.5714, -81.3328], 'Sumter': [28.6983, -82.0493], 'Suwannee': [30.2916, -82.9365], 'Taylor': [30.0519, -83.5826], 'Union': [30.0158, -82.3418], 'Volusia': [29.0280, -81.3087], 'Wakulla': [30.1705, -84.3802], 'Walton': [30.4216, -86.1013], 'Washington': [30.7818, -85.5505] };
        const floridaCounties = Object.keys(countyCoordinates);
        const appId = 'florida-animal-cruelty-tracker';
        
        let app, auth, db, casesCollection;
        let allCases = [];
        let countyChart, statusChart;
        let map;
        let markerLayer = L.layerGroup();

        // FIX: Declare DOM element variables in the global scope
        let loadingSpinner, caseListings, noResultsDiv, noResultsMessage, searchInput, countyFilter, statusFilter, dateFilter, modalContainer, reportCaseBtn, submitCaseBtn, countyListDatalist, toast, toastMessage;

        // --- UTILITY FUNCTIONS ---
        const escapeHTML = (str) => {
            if (!str) return '';
            return str.replace(/[&<>"']/g, (match) => {
                switch (match) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return match;
                }
            });
        };

        const showToast = (message, isError = false) => {
            if (!toast || !toastMessage) return;
            toastMessage.textContent = message;
            toast.className = `toast fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };

        // --- MAIN APP FUNCTIONS ---
        async function initializeAppAndData() {
             if (!firebaseConfig || !firebaseConfig.apiKey) {
                loadingSpinner.innerHTML = `<div class="text-red-600 bg-red-100 border border-red-400 rounded-lg p-4 max-w-2xl mx-auto"><h3 class="font-bold text-lg">Configuration Error</h3><p class="mt-2">Firebase configuration is missing or invalid. The live site uses secrets for configuration.</p></div>`;
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                const user = auth.currentUser;
                if (user) {
                    const casesCollectionPath = `/artifacts/${appId}/public/data/cases`;
                    casesCollection = collection(db, casesCollectionPath);
                    setupRealtimeListener();
                } else {
                     loadingSpinner.innerHTML = '<p class="text-red-500 font-semibold">Authentication failed. Unable to load cases.</p>';
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingSpinner.innerHTML = '<p class="text-red-500 font-semibold">Error connecting to the database.</p>';
            }
        }
        
        function setupRealtimeListener() {
            onSnapshot(casesCollection, (snapshot) => {
                allCases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allCases.sort((a, b) => new Date(b.incidentDate) - new Date(a.incidentDate));
                loadingSpinner.classList.add('hidden');
                populateFilters();
                applyFilters();
            }, (error) => {
                console.error("Error listening to database:", error);
                loadingSpinner.innerHTML = '<p class="text-red-500 font-semibold">Error fetching real-time data.</p>';
            });
        }
        
        function renderCases(casesToRender) {
            caseListings.innerHTML = '';
            const hasActiveFilters = searchInput.value || countyFilter.value || statusFilter.value || dateFilter.value;
            noResultsDiv.classList.toggle('hidden', casesToRender.length > 0);
            if(allCases.length === 0) {
                 noResultsMessage.textContent = 'The database is currently empty. Be the first to submit a case!';
            } else if (hasActiveFilters) {
                 noResultsMessage.textContent = 'No cases match your current filter criteria.';
            }
            caseListings.classList.toggle('hidden', casesToRender.length === 0);

            casesToRender.forEach(caseData => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm overflow-hidden transform hover:-translate-y-1 transition-transform duration-300';
                const statusColors = { 'Pending Trial': 'bg-yellow-500', 'Awaiting Plea': 'bg-blue-500', 'Sentenced': 'bg-green-600', 'Arrested': 'bg-indigo-500', 'Pending Review': 'bg-pink-500' };
                const statusColor = statusColors[caseData.status] || 'bg-gray-500';
                card.innerHTML = `
                    <div class="p-5">
                        <div class="flex justify-between items-start">
                             <p class="text-sm text-gray-500">${escapeHTML(caseData.county)} County</p>
                             <span class="text-xs font-semibold text-white ${statusColor} px-2 py-1 rounded-full">${escapeHTML(caseData.status)}</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mt-2">${escapeHTML(caseData.defendant)}</h3>
                        <p class="text-sm text-gray-600">${caseData.caseNumber ? `Case #${escapeHTML(caseData.caseNumber)}`: '&nbsp;'}</p>
                        <div class="mt-4 border-t border-gray-200 pt-4">
                            <p class="text-sm"><strong class="font-medium text-gray-700">Incident:</strong> ${escapeHTML(new Date(caseData.incidentDate).toLocaleDateString(undefined, { timeZone: 'UTC' }))}</p>
                            <p class="text-sm"><strong class="font-medium text-gray-700">Animal:</strong> ${escapeHTML(caseData.animalType)}</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-5 py-3 flex justify-between items-center">
                        <button class="view-details-btn text-sm font-semibold text-red-600 hover:text-red-800" data-case-id="${caseData.id}">View Details</button>
                        ${caseData.isUserSubmitted ? '<span class="text-xs text-gray-400">User Submitted</span>' : ''}
                    </div>
                `;
                caseListings.appendChild(card);
            });
        }
        
        function populateFilters() {
            const counties = [...new Set(allCases.map(c => c.county))];
            const statuses = [...new Set(allCases.map(c => c.status))];
            const repopulateSelect = (selectEl, options) => {
                const currentValue = selectEl.value;
                selectEl.innerHTML = '<option value="">All</option>';
                options.sort().forEach(opt => {
                     const option = document.createElement('option');
                     option.value = opt;
                     option.textContent = opt;
                     selectEl.appendChild(option);
                });
                selectEl.value = currentValue;
            };
            repopulateSelect(countyFilter, counties);
            repopulateSelect(statusFilter, statuses);
        }
        
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCounty = countyFilter.value;
            const selectedStatus = statusFilter.value;
            const selectedDate = dateFilter.value;
            const filteredCases = allCases.filter(c => {
                const s = c.defendant?.toLowerCase() || '';
                const cn = c.caseNumber?.toLowerCase() || '';
                const matchesSearch = s.includes(searchTerm) || cn.includes(searchTerm);
                const matchesCounty = !selectedCounty || c.county === selectedCounty;
                const matchesStatus = !selectedStatus || c.status === selectedStatus;
                const matchesDate = !selectedDate || c.incidentDate >= selectedDate;
                return matchesSearch && matchesCounty && matchesStatus && matchesDate;
            });
            renderCases(filteredCases);
            updateCharts(filteredCases);
            updateStats();
            updateMap(filteredCases);
        }

        function openModal(identifier, type) {
            let modalHTML = '';
            const baseModal = (title, content, footer) => `
                <div id="modal-backdrop" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl transform overflow-y-auto max-h-full">
                        <div class="p-6 sm:p-8"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-900">${title}</h2><button class="close-modal-btn text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button></div>${content}</div>
                        <div class="bg-gray-100 px-6 py-4 text-right rounded-b-xl">${footer}</div>
                    </div>
                </div>
            `;
            if (type === 'report') {
                modalHTML = baseModal('How to Report Animal Cruelty', `<div class="text-gray-700 space-y-4"><p class="font-bold text-red-600">If you witness an animal in a life-threatening situation, call 911 immediately.</p><p>For non-emergency concerns, contact your local county sheriff's office or animal control agency. Providing a location, date, time, and description is crucial.</p></div>`, `<button class="close-modal-btn px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Close</button>`);
            } else if (type === 'submit') {
                 modalHTML = baseModal('Submit a New Case', `<form id="submit-case-form" class="space-y-4" novalidate><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="defendant" class="block text-sm font-medium">Defendant Name*</label><input type="text" id="defendant" required class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div><div><label for="county" class="block text-sm font-medium">County*</label><input type="text" id="county" required list="county-list" class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div><div><label for="caseNumber" class="block text-sm font-medium">Case Number</label><input type="text" id="caseNumber" class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div><div><label for="incidentDate" class="block text-sm font-medium">Incident Date*</label><input type="date" id="incidentDate" required class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div></div><div><label for="animalType" class="block text-sm font-medium">Animal Type(s)*</label><input type="text" id="animalType" placeholder="e.g., Dogs, Cats" required class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div><div><label for="summary" class="block text-sm font-medium">Summary*</label><textarea id="summary" rows="3" required class="mt-1 w-full border-gray-300 rounded-md p-3"></textarea></div><div><label for="source" class="block text-sm font-medium">Source Link*</label><input type="url" id="source" required placeholder="https://" class="mt-1 w-full border-gray-300 rounded-md h-10 px-3"></div><div id="submit-error" class="text-red-600 text-sm hidden font-semibold"></div><p class="text-xs text-gray-500">*Required field.</p></form>`, `<button id="form-submit-btn" type="submit" form="submit-case-form" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Submit Case</button>`);
            } else if (type === 'details') {
                const caseData = allCases.find(c => c.id === identifier);
                if (!caseData) return;
                 const chargesHTML = Array.isArray(caseData.charges) && caseData.charges.length > 0 ? caseData.charges.map(charge => `<li>${escapeHTML(charge)}</li>`).join('') : '<li>No charges listed.</li>';
                 const formattedDate = caseData.incidentDate ? new Date(caseData.incidentDate).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }) : 'N/A';
                 modalHTML = baseModal('Case Details', 
                    `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-gray-700">
                        <div><strong class="font-semibold text-gray-900">Case #:</strong> ${escapeHTML(caseData.caseNumber) || 'N/A'}</div>
                        <div><strong class="font-semibold text-gray-900">County:</strong> ${escapeHTML(caseData.county)}</div>
                        <div class="md:col-span-2"><strong class="font-semibold text-gray-900">Defendant:</strong> ${escapeHTML(caseData.defendant)}</div>
                        <div><strong class="font-semibold text-gray-900">Incident Date:</strong> ${escapeHTML(formattedDate)}</div>
                        <div><strong class="font-semibold text-gray-900">Status:</strong> ${escapeHTML(caseData.status)}</div>
                    </div>
                    <div class="mt-6 border-t pt-4"><h4 class="font-semibold text-gray-900 mb-2">Charges</h4><ul class="list-disc list-inside space-y-1 text-gray-700">${chargesHTML}</ul></div>
                     <div class="mt-4 border-t pt-4"><h4 class="font-semibold text-gray-900 mb-2">Summary</h4><p class="text-gray-700 leading-relaxed">${escapeHTML(caseData.summary)}</p></div>
                     ${caseData.source ? `<div class="mt-4 border-t pt-4"><h4 class="font-semibold text-gray-900 mb-2">Source</h4><a href="${escapeHTML(caseData.source)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline break-all">${escapeHTML(caseData.source)}</a></div>` : ''}
                    `,
                    `<button class="close-modal-btn px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Close</button>`
                );
            }
            modalContainer.innerHTML = modalHTML;
            modalContainer.querySelector('.close-modal-btn').addEventListener('click', closeModal);
            modalContainer.querySelector('#modal-backdrop')?.addEventListener('click', (e) => { if(e.target.id === 'modal-backdrop') closeModal() });
            if (type === 'submit') {
                document.getElementById('submit-case-form').addEventListener('submit', handleCaseSubmit);
            }
        }

        function closeModal() {
            modalContainer.innerHTML = '';
        }

        async function handleCaseSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = document.getElementById('form-submit-btn');
            const errorDiv = document.getElementById('submit-error');
            const countyInput = form.county;
            if (!floridaCounties.includes(countyInput.value)) {
                errorDiv.textContent = 'Please select a valid Florida county from the list.';
                errorDiv.classList.remove('hidden');
                countyInput.focus();
                countyInput.classList.add('border-red-500');
                return;
            } else {
                 countyInput.classList.remove('border-red-500');
            }
            if(!form.checkValidity()){
                errorDiv.textContent = 'Please fill out all required fields correctly.';
                errorDiv.classList.remove('hidden');
                form.reportValidity();
                return;
            }
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Submitting...';
            errorDiv.classList.add('hidden');
            const newCase = {
                defendant: form.defendant.value.trim(), county: form.county.value.trim(),
                caseNumber: form.caseNumber.value.trim() || null, incidentDate: form.incidentDate.value,
                animalType: form.animalType.value.trim(), summary: form.summary.value.trim(),
                source: form.source.value.trim(), status: 'Pending Review', isUserSubmitted: true,
                createdAt: serverTimestamp(), charges: []
            };
            try {
                await addDoc(casesCollection, newCase);
                closeModal();
                showToast("Case submitted successfully!");
            } catch (error) {
                console.error("Error submitting case:", error);
                errorDiv.textContent = 'Submission failed. Please try again.';
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Case';
            }
        }
        
        function updateStats() {
            const totalCases = allCases.length;
            const pendingStatuses = ['Pending Trial', 'Awaiting Plea', 'Pending Review', 'Arrested'];
            const pendingCases = allCases.filter(c => pendingStatuses.includes(c.status)).length;
            const countyCount = new Set(allCases.map(c => c.county)).size;
            document.getElementById('total-cases-stat').textContent = totalCases;
            document.getElementById('pending-cases-stat').textContent = pendingCases;
            document.getElementById('county-count-stat').textContent = countyCount;
        }
        
        function createCharts() {
            Chart.defaults.font.family = "'Inter', sans-serif";
            const countyCtx = document.getElementById('county-chart').getContext('2d');
            countyChart = new Chart(countyCtx, { type: 'bar', data: { labels: [], datasets: [{ label: '# of Cases', data: [], backgroundColor: 'rgba(220, 38, 38, 0.6)', borderColor: 'rgba(220, 38, 38, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Cases by County (Top 10)' } } } });
            const statusCtx = document.getElementById('status-chart').getContext('2d');
            statusChart = new Chart(statusCtx, { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#FBBF24', '#3B82F6', '#16A34A', '#6366F1', '#EC4899', '#8B5CF6'] }] }, options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Case Status Distribution' } } } });
        }
        
        function updateCharts(chartCases) {
            if (!countyChart || !statusChart) return;
            const countyCounts = chartCases.reduce((acc, c) => { acc[c.county] = (acc[c.county] || 0) + 1; return acc; }, {});
            const sortedCounties = Object.entries(countyCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            countyChart.data.labels = sortedCounties.map(entry => entry[0]);
            countyChart.data.datasets[0].data = sortedCounties.map(entry => entry[1]);
            countyChart.update();
            const statusCounts = chartCases.reduce((acc, c) => { acc[c.status] = (acc[c.status] || 0) + 1; return acc; }, {});
            statusChart.data.labels = Object.keys(statusCounts);
            statusChart.data.datasets[0].data = Object.values(statusCounts);
            statusChart.update();
        }

        function initializeMap() {
            map = L.map('map').setView([28.5, -82.5], 7);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            }).addTo(map);
            markerLayer.addTo(map);
        }

        function updateMap(casesToDisplay) {
            if (!map) return;
            markerLayer.clearLayers();
            casesToDisplay.forEach(c => {
                const coords = countyCoordinates[c.county.trim()];
                if (coords) {
                    const popupContent = `<h4 class="font-bold">${escapeHTML(c.defendant)}</h4><p>${escapeHTML(c.county)} County</p><button class="popup-view-details mt-2 text-sm font-semibold text-red-600" data-case-id="${c.id}">View Details</button>`;
                    L.marker(coords).bindPopup(popupContent).addTo(markerLayer);
                }
            });
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // FIX: Assign elements to the globally-scoped variables once the DOM is ready.
            loadingSpinner = document.getElementById('loading-spinner');
            caseListings = document.getElementById('case-listings');
            noResultsDiv = document.getElementById('no-results');
            noResultsMessage = document.getElementById('no-results-message');
            searchInput = document.getElementById('search');
            countyFilter = document.getElementById('county-filter');
            statusFilter = document.getElementById('status-filter');
            dateFilter = document.getElementById('date-filter');
            modalContainer = document.getElementById('modal-container');
            reportCaseBtn = document.getElementById('report-case-btn');
            submitCaseBtn = document.getElementById('submit-case-btn');
            countyListDatalist = document.getElementById('county-list');
            toast = document.getElementById('toast');
            toastMessage = document.getElementById('toast-message');

            // --- Setup Initial State ---
            countyListDatalist.innerHTML = floridaCounties.map(county => `<option value="${county}"></option>`).join('');

            // --- Start Application Logic ---
            initializeAppAndData();
            initializeMap();
            createCharts();

            // --- Attach Event Listeners ---
            searchInput.addEventListener('input', applyFilters);
            countyFilter.addEventListener('change', applyFilters);
            statusFilter.addEventListener('change', applyFilters);
            dateFilter.addEventListener('change', applyFilters);
            reportCaseBtn.addEventListener('click', () => openModal(null, 'report'));
            submitCaseBtn.addEventListener('click', () => openModal(null, 'submit'));

            // Use event delegation for dynamically created elements inside the main body
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-details-btn')) {
                    openModal(e.target.dataset.caseId, 'details');
                }
                if (e.target.classList.contains('popup-view-details')) {
                    map.closePopup();
                    openModal(e.target.dataset.caseId, 'details');
                }
            });
        });

    </script>
</body>
</html>

